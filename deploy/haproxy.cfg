# HAProxy Configuration for G-Rump
# Load balances across multiple backend instances

global
    maxconn 10000
    log stdout format raw local0 info
    stats timeout 30s
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    retries 3
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s
    errorfile 503 /usr/local/etc/haproxy/errors/503.http

# Stats page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# Main frontend
frontend grump_frontend
    bind *:3000
    
    # CORS headers for preflight
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # Health check bypass
    acl is_health_check path_beg /health
    
    # SSE connections need longer timeouts
    acl is_sse path_end /stream
    acl is_sse path_beg /api/chat/stream
    acl is_sse path_beg /api/ship/stream
    acl is_sse path_beg /api/agents/swarm
    
    # Websocket upgrade
    acl is_websocket hdr(Upgrade) -i WebSocket
    
    # Route to backends
    use_backend grump_backend_sse if is_sse
    use_backend grump_backend_ws if is_websocket
    default_backend grump_backend

# Regular HTTP backend with round-robin
backend grump_backend
    balance roundrobin
    option httpchk GET /health/quick
    http-check expect status 200
    
    # Cookie-based session affinity (optional, for non-Redis sessions)
    cookie SERVERID insert indirect nocache
    
    # Dynamic backend discovery using Docker DNS
    server-template backend 10 backend:3000 check resolvers docker init-addr libc,none

# SSE backend with longer timeouts
backend grump_backend_sse
    balance leastconn
    option httpchk GET /health/quick
    http-check expect status 200
    
    # Longer timeouts for SSE streams
    timeout server 5m
    timeout tunnel 5m
    
    # Disable buffering for streaming
    option http-buffer-request
    
    server-template backend 10 backend:3000 check resolvers docker init-addr libc,none

# WebSocket backend
backend grump_backend_ws
    balance leastconn
    option httpchk GET /health/quick
    http-check expect status 200
    
    # WebSocket specific timeouts
    timeout server 1h
    timeout tunnel 1h
    
    server-template backend 10 backend:3000 check resolvers docker init-addr libc,none

# Docker DNS resolver
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 10s
    hold refused 10s
    hold nx 10s
    hold timeout 10s
    hold valid 10s
    hold obsolete 10s
